# 定时通知功能说明

## 功能概述

降雨预警系统现已支持**客户端定时通知**功能，可以在您指定的时间自动检查天气数据，当降雨概率超过阈值时通过微信推送预警通知。

---

## 核心特性

### ✨ 智能定时调度
- **每分钟自动检查** - 系统每分钟检查一次是否到达通知时间
- **多时间点支持** - 可配置多个通知时间点（早上、晚上等）
- **灵活推送目标** - 支持推送"今天"或"明天"的天气预报

### 🎯 智能预警触发
- **阈值检测** - 只在降雨概率超过设定阈值时发送通知
- **多城市监控** - 一次检查所有监控城市的天气状况
- **防重复发送** - 同一时间点 12 小时内只发送一次通知

### 📊 实时状态显示
- **下次通知时间** - 清晰显示下一次通知的时间
- **剩余时间倒计时** - 实时显示距离下次通知还有多久
- **定时器运行状态** - 显示定时器是否正常运行
- **最后检查时间** - 记录最后一次执行检查的时间

---

## 使用指南

### 步骤 1: 配置推送服务

1. 访问 [Server酱](https://sct.ftqq.com/) 或 [PushPlus](https://www.pushplus.plus/)
2. 注册并获取推送 Token
3. 在应用的「通知设置」页面输入 Token

### 步骤 2: 配置预警阈值

- 滑动阈值滑块设置触发通知的降雨概率
- **10% - 敏感** - 较低概率也会通知，适合对天气变化敏感的用户
- **50% - 适中** - 推荐设置，平衡提醒频率和准确性
- **90% - 保守** - 只在高概率时通知，减少打扰

### 步骤 3: 启用通知时间点

系统预设了 3 个通知时间：

| 时间 | 推送内容 | 描述 |
|-----|---------|------|
| 08:00 | 今日天气 | 早上 8 点推送当天降雨预警 |
| 18:00 | 明日天气 | 晚上 6 点推送明日降雨预警 |
| 21:00 | 明日天气 | 晚上 9 点推送明日降雨预警 |

您可以：
- 启用/禁用单个时间点
- 根据需求自定义时间（需修改代码）

### 步骤 4: 启用通知

打开「启用通知」开关，系统将：
- ✅ 立即执行一次通知检查
- ✅ 每分钟自动检查是否到达通知时间
- ✅ 显示定时器运行状态和下次通知时间

---

## 工作原理

### 通知检查流程

```
┌─────────────────────────────────────┐
│  每分钟检查一次（浏览器定时器）      │
└─────────────────┬───────────────────┘
                  │
                  ▼
        ┌─────────────────┐
        │ 是否到达通知时间？│
        └────────┬────────┘
                 │
         是 ┌────┴────┐ 否
            │         │
            ▼         ▼
    ┌───────────┐  等待下一次检查
    │ 检查天气数据│
    └─────┬─────┘
          │
          ▼
    ┌─────────────────┐
    │ 计算降雨概率     │
    └─────┬───────────┘
          │
          ▼
    ┌─────────────────┐
    │ 超过阈值？       │
    └────┬────────┘
         │
    是 ┌─┴──┐ 否
       │    │
       ▼    ▼
  发送通知  跳过
```

### 时间匹配逻辑

系统使用 **2 分钟误差范围** 进行时间匹配：

```typescript
// 例如：通知时间设置为 18:00
// 实际在 17:58 - 18:02 之间的检查都会触发
// 这样可以避免因为定时器微小偏差而错过通知
```

### 防重复机制

- 使用 localStorage 记录每次通知的发送时间
- 同一时间点 12 小时内只发送一次
- 标识符：`{日期}-{时间点ID}`

---

## 通知内容示例

当降雨概率超过阈值时，您会收到类似这样的通知：

```
【降雨预警】北京 - 🟠 中预警

预警详情

📍 城市：北京
🌧️ 降雨概率：75%
⚠️ 预警阈值：50%
🌤️ 天气状况：小雨转中雨
🟠 中风险等级

建议：🟠 降雨可能性较大，建议携带雨具

---
时间：2024-01-15 18:00:23

请及时做好防雨准备！
```

---

## 注意事项与限制

### ⚠️ 重要提示

1. **需要保持网页打开**
   - 定时器在浏览器中运行
   - 关闭网页后定时器停止工作
   - 建议在常开设备（如家庭电脑）上使用

2. **需要配置 API Key**
   - 必须配置和风天气 API Key 才能获取真实数据
   - 未配置时会使用模拟数据，仅用于演示

3. **需要配置推送 Token**
   - 必须配置 Server酱或 PushPlus Token
   - 才能收到微信通知

4. **浏览器限制**
   - 部分浏览器在后台时会限制定时器
   - 建议使用 Chrome/Edge 浏览器
   - 保持页面在前台或标签页激活状态

### 🔧 未来改进方向

如果您需要更可靠的定时通知，可以考虑：

1. **部署到服务器**
   - 使用 Vercel Cron Jobs
   - 使用 GitHub Actions 定时工作流
   - 使用云函数（腾讯云/阿里云）
   - 自建服务器 + node-cron

2. **使用 Service Worker**
   - 实现后台定时任务
   - 支持网页关闭后继续运行

3. **使用 Web Push API**
   - 浏览器原生推送通知
   - 不依赖第三方服务

---

## 常见问题

### Q1: 为什么没有收到通知？

请检查以下项目：
- ✅ 是否启用了「通知开关」
- ✅ 是否配置了微信推送 Token
- ✅ 是否配置了天气 API Key
- ✅ 网页是否保持打开状态
- ✅ 当前时间是否接近设置的通知时间
- ✅ 降雨概率是否超过阈值

### Q2: 定时器会消耗很多资源吗？

不会。定时器非常轻量：
- 每分钟只执行一次简单的检查
- 大部分时间都在等待
- 对 CPU 和内存几乎没有影响

### Q3: 可以自定义通知时间吗？

可以，但需要修改代码。在 `src/types/index.ts` 的 `DEFAULT_SCHEDULES` 数组中修改：

```typescript
{
  id: 'custom-morning',
  time: '07:00',  // 修改为想要的时间
  targetDate: 'today',
  enabled: true,
  description: '早上7点推送当日天气'
}
```

### Q4: 支持多个推送渠道吗？

目前只支持 Server酱（微信推送）。未来计划支持：
- 邮件通知
- 短信通知
- 浏览器桌面通知
- Telegram Bot
- 钉钉/飞书机器人

### Q5: 通知会发送到所有城市吗？

是的。如果某个时间点触发通知，系统会检查**所有监控城市**的降雨概率，对超过阈值的每个城市单独发送通知。

---

## 技术实现

### 核心文件

- **`src/lib/scheduler.ts`** - 调度器核心逻辑
- **`src/hooks/useScheduler.ts`** - React Hook 封装
- **`src/lib/notification.ts`** - 微信推送服务
- **`src/pages/NotificationPage.tsx`** - 通知配置界面

### 数据存储

使用 localStorage 存储：
- `rain-scheduler-{date}-{scheduleId}` - 通知发送记录
- `rain-scheduler-history` - 通知历史记录（最近100条）

---

## 开发与调试

### 手动触发通知检查

在浏览器控制台执行：

```javascript
// 获取 React DevTools 中的调度器实例
// 或重新加载页面触发立即检查
```

### 查看通知历史

通知历史记录存储在 localStorage 中：

```javascript
// 在浏览器控制台执行
JSON.parse(localStorage.getItem('rain-scheduler-history'))
```

### 清空通知记录

```javascript
localStorage.removeItem('rain-scheduler-history')
```

---

## 更新日志

### v1.1.0 (2024-01-29)
- ✨ 新增客户端定时通知功能
- ✨ 支持多时间点配置
- ✨ 实时显示定时器状态
- ✨ 通知发送历史记录
- 🐛 修复防重复发送逻辑
- 📝 完善文档说明

---

如有问题或建议，欢迎提交 Issue！
